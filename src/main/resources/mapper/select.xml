<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="">
    <select id="DynamicSQL" resultType="java.util.HashMap">
        ${sql}
    </select>

    <select id="fetchComponentTemplateVariables" resultType="java.lang.String">
        SELECT jsonb_object_agg(component, endpoints) AS result FROM (
        (SELECT
        component,
        jsonb_object_agg(endpoint, data) AS endpoints
        FROM (SELECT distinct component,"templateName" as endpoint, '[]'::jsonb AS data
        FROM (
        SELECT distinct component,"templateName" FROM auto_case_template
        ) sub
        GROUP BY component,"templateName") a
        GROUP BY component
        )
        union
        (select component,'{}' from auto_api_configuration where component not in (select distinct component from
        auto_case_template))
        ) sub limit 1
    </select>

    <select id="fetchIdByComponentAndScenario" resultType="java.lang.Integer">
        SELECT id FROM auto_case_scenario WHERE component = #{component} AND scenario = #{scenario} AND summary =
        #{summary} AND "issueKey" = #{issueKey} AND label = #{label} limit 1
    </select>

    <select id="fetchSingleAutoCaseAuditDetail" resultType="java.util.Map">
        select "runId" as runId, "runMode" as runMode, suite as suite, "issueKey" || ' ' || summary as name, "caseId",
        "runStatus", jsonb_array_length(element -> 'steps') as "totalSteps", cast(element->>'passedSteps' as int)
        as "passedSteps",
        jsonb_array_length(element -> 'steps') - cast(element->>'passedSteps' as int) as "failedSteps", "testData"
        as "auditData",
        jsonb_build_object('id', step -> 'line', 'name', step->'name', 'output', step->'output' ||
        COALESCE(step->'result'->>'error_message', '{}'), 'status', step->'result'->>'status') as "testResults"
        from auto_case_audit, jsonb_array_elements(element -> 'steps') step where "caseId" = ${caseId}
        and "runId" = Any(string_to_array('${runIds}',',')) group by "caseId","runId",region, env,"issueKey",summary,
        "runStatus",element,"testData"
    </select>

    <select id="fetchAutoCaseAuditBaseOnComponentForAPI" resultType="java.util.Map">
        with f as (
        SELECT DISTINCT
        e.id AS "caseId",
        e.component AS "mainComponent",
        CASE WHEN jsonb_array_length(e."componentLike") = 0 THEN '' ELSE e."componentLike" ->> 0
        END AS "componentLikeFirst",
        e.scenario,
        UPPER('${region}') AS region,
        UPPER('${env}') AS env,
        COALESCE(e."serviceName",'') AS "serviceName",
        e.label,
        e."issueKey",
        e.summary,
        CAST(COALESCE(e.script,'[]') AS varchar) AS "templateScript",
        CAST(COALESCE(e.script,'[]') AS varchar) AS "caseScript",
        CAST(COALESCE(e."testData",'{}') AS varchar) AS "testData",
        CAST(COALESCE(e.variables,'{}') AS varchar) AS "templateVariables",
        CAST(COALESCE(e.variables,'{}') AS varchar) AS "caseVariables",
        e."isTemplate"
        FROM
        auto_case_scenario e
        left JOIN
        auto_case_template s
        ON s.component = e.component AND s."templateName" = e."templateName"
        left JOIN
        auto_api_configuration c
        on c.component = e.component
        left join auto_endpoint_all aa on aa.path = e.endpoint and aa.method = e.method,
        jsonb_array_elements_text(c.profile) AS p where (aa.active = true or aa.active is null)
        <if test="scenarios !=null and scenarios !=''">"
            and e.scenario = Any(string_to_array('${scenarios}',','))
        </if>
        <if test="label !=null and label !=''">"
            and e.label = '${label}'
        </if>
        <if test="sanityOnly !=null and sanityOnly !=''" and sanityOnly=='true'">"
            and e."isSanity" = true
        </if>
        <if test="profile !=null and profile !=''">"
            and UPPER(p) like '%${profile}%'
        </if>
        <if test="module !=null and module !=''">"
            and c.module like '%${module}%'
        </if>
        <if test="id !=null and id !=''">"
            and e.id = ${id}
        </if>
        <if test="id == '' or id == null">"
            and e.enable = true
        </if>
        )
        select
        '${runId}' as "runId",
        '${runMode}' as "runMode",
        '${runStatus}' as "runStatus",
        '{}' as element,
        <choose>
            <when test="component!=null and component!=''">"
                '${component}###' || f.region || f.env as suite,
                '${component}' as component,
            </when>
            <otherwise>
                f."mainComponent" || '###' || f.region || f.env as suite,
                f."mainComponent" as component,
            </otherwise>
        </choose>
        f."caseId",
        f."mainComponent",
        f."componentLikeFirst",
        f.scenario,
        f."serviceName",
        f.region,
        f.env,
        f.label,
        f."issueKey",
        f.summary,
        f."templateScript",
        f."caseScript",
        f."testData",
        f."templateVariables",
        f."caseVariables",
        f."isTemplate" from f
        <if test="component != null and component !=''">"
            where f."mainComponent" = Any(string_to_array('${component}',','))
            or f."componentLikeFirst" = Any(string_to_array('${component}',','))
        </if>
    </select>

    <select id="fetchAutoCaseAuditBaseOnComponentForUI" resultType="java.util.Map">
        with f as (
        SELECT DISTINCT
        e.id AS "caseId",
        e.component AS "mainComponent",
        CASE WHEN jsonb_array_length(e."componentLike") = 0 THEN '' ELSE
        e."componentLike" ->> 0 END AS "componentLikeFirst",
        e.scenario,
        UPPER('${region}') AS region,
        UPPER('${env}') AS env,
        COALESCE(e."serviceName",'') AS "serviceName",
        e.label,
        e."issueKey",
        e.summary,
        CAST(COALESCE(e."processedScript" ->, lower('${profile}'),'[]') AS varchar) AS "caseScript",
        CAST(COALESCE(e."testData" -> 'default' || COALESCE(e."testData" ->
        lower('${profile}'),'{}'),'{}') AS varchar) AS "testData",
        CAST(COALESCE(e.variable,'{}') AS varchar) AS "caseVariable"
        FROM
        auto_case_ui e
        left JOIN
        auto_api_configuration c
        on c.component = e.component
        <where>
            <if test="scenarios !=null and scenarios !=''">"
                and e.scenario = Any(string_to_array('${scenarios}',','))
            </if>
            <if test="label !=null and label !=''">"
                and e.label = '${label}'
            </if>
            <if test="sanityOnly !=null and sanityOnly !=''" and sanityOnly=='true'">"
                and e."isSanity" = true
            </if>
            <if test="profile !=null and profile !=''">"
                and e."profileSupport" @> '["${profile}"]'
            </if>
            <if test="module !=null and module !=''">"
                and c.module like '%${module}%'
            </if>
            <if test="id !=null and id !=''">"
                and e.id = ${id}
            </if>
            <if test="id == '' or id == null">"
                and e.enable = true
            </if>
        </where>
        )
        select
        '${runId}' as "runId",
        '${runMode}' as "runMode",
        '${runStatus}' as "runStatus",
        '{}' as element,
        <choose>
            <when test="component!=null and component!=''">"
                '${component}###' || f.region || f.env as suite,
                '${component}' as component,
            </when>
            <otherwise>
                f."mainComponent" || '###' || f.region || f.env as suite,
                f."mainComponent" as component,
            </otherwise>
        </choose>
        f."caseId",
        f."mainComponent",
        f."componentLikeFirst",
        f.scenario,
        f."serviceName",
        f.region,
        f.env,
        f.label,
        f."issueKey",
        f.summary,
        f."caseScript",
        f."testData",
        f."caseVariable" from f
        <if test="component != null and component !=''">"
            where f."mainComponent" = Any(string_to_array('${component}',',')) or f."componentLikeFirst"
            = Any(string_to_array('${component}',','))
        </if>
    </select>

    <select id="fetchAutoConfigurationBasedOnSingleComponent" resultType="java.util.Map">
        WITH config_data AS (
        SELECT DISTINCT
        a.name AS suite,
        b."serviceName" AS svc,
        a."fastProject",
        COALESCE('${projectKey}', a."projectKey") AS "projectKey",
        a."fastDashboardEnv",
        COALESCE('${releaseversion}', a."dailyrunVersion") AS "releaseVersion",
        REPLACE(REPLACE(a."receiverAddress", ' ', ''), ',', ';') AS "toEmail",
        REPLACE(REPLACE(a."copyAddress", ' ', ''), ',', ';') AS "ccEmail",
        a.module,
        a."enableJira"::varchar AS "enableJira",
        a."enableEmail"::varchar AS "enableEmail",
        a."enableDash"::varchar AS "enableDash"
        FROM
        auto_api_configuration a
        JOIN
        auto_api_configuration b ON b=1
        WHERE
        a.component = '${component}'
        AND b.component = '${mainComponent}'
        AND a.enable = true
        )
        SELECT
        f.suite,
        f."fastProject",
        '${buildId}' as "buildId",
        'Regression' as "testType",
        'Regression' as "testScope",
        'Regression' as group,
        UPPER('${region}') as region,
        UPPER('${env}') as env,
        f."projectKey",
        f."fastDashboardEnv",
        f."releaseVersion",
        f."toEmail",
        f."ccEmail",
        f.module,
        '${runId}' as "runId",
        '${runMode}' as "runMode",
        '${runBy}' as "runBy",
        '${component}' as component,
        f.svc as "serviceName",
        f."enableJira",
        'false' as "enableEmail",
        f."enableDash"
        FROM
        config_data f limit 1
    </select>

    <select id="fetchFinalFeature" resultType="java.util.Map">
        select ROW_NUMBER() OVER (ORDER BY scenario desc, name, UPPER(region || env) as profile,
        COUNT(*) as "totalCases", COUNT(CASE WHEN "runStatus" = 'PASSED' THEN 1 ELSE NULL END) as "passedCases",
        jsonb_agg(element) as elements FROM auto_case_audit
        WHERE "runId" = '${runId}' GROUP BY scenario, region, env order by scenario asc
    </select>

    <select id="fetchAutoCaseUIMethod" resultType="java.util.Map">
        SELECT id,method,COALESCE(options,'{}') as options FROM auto_case_ui_method
    </select>

    <select id="fetchEhService" resultType="java.util.Map">
        SELECT "displayName" as name FROM eh_service
    </select>

    <select id="fetchAutoCaseAuditForAutoCaseUI" parameterType="map" resultType="map">
        SELECT f."caseId", f.component, f.profile, f.scenario, f."issueKey", f.summary,
        f.label, f.script, f.variables, f."testData", f."componentLike"
        FROM (
        select
        id AS "caseId",
        #{component} AS component,
        jsonb_array_elements_text("profileSupport") AS profile,
        scenario,
        "issueKey",
        summary,
        label,
        variables,
        "testData",
        script,
        "componentLike"
        FROM auto_case_ui
        WHERE 1=1
        <if test="caseId == null or caseId == ''">"
            AND enable = true
            AND ("isSanity" = true OR "isSanity" = #{sanityOnly})
            AND (component = #{component} OR jsonb_contains("componentLike", '"' || #{component} || '"'))
        </if>
        <if test="caseId != null and caseId != ''">"
            AND id = #{caseId}
        </if>
        ) f
        WHERE f.profile = #{profile}
        GROUP BY f."caseId", f.component, f.profile, f.scenario, f."issueKey", f.summary, f.label, f.variables,
        f."testData", f."componentLike";
    </select>

    <select id="buildFeaturesByRunId" parameterType="string" resultType="string">
        SELECT jsonb_agg(f.result)
        FROM (
        SELECT jsonb_build_object(
        'line', 0,
        'elements', jsonb_agg(element),
        'name', scenario,
        'profile', UPPER(region || env),
        'totalCases', COUNT(*),
        'passedCases', COUNT(CASE WHEN "runStatus" = 'PASSED' THEN 1 ELSE NULL END)
        ) AS result
        FROM auto_case_audit
        WHERE "runId" = #{runId}
        GROUP BY scenario, region, env
        ) f
        LIMIT 1
    </select>

    <select id="buildConfigByRunId" parameterType="string" resultType="string">
        SELECT DISTINCT config
        FROM auto_case_audit
        WHERE "runId" = #{runId}
        LIMIT 1
    </select>

    <select id="checkSvcFromAutoBaseURL" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM auto_baseurl
        WHERE service_name = #{serviceName} AND profile = #{profileName};
    </select>

    <select id="fetchFinalTestResultFromAudit" parameterType="map" resultType="string">
        select jsonb_build_object(
        'runId', "runId",
        'profile', UPPER(region || env),
        'name', "issueKey" || ' ' || summary,
        'caseId', "caseId",
        'runStatus', "runStatus",
        'totalSteps', jsonb_array_length(element -> 'steps'),
        'passedSteps', SUM(CASE WHEN step -> 'result' -> 'status' = 'passed' THEN 1 ELSE NULL END),
        'failedSteps', SUM(CASE WHEN step -> 'result' -> 'status' != 'passed' THEN 1 ELSE NULL END),
        'auditData', "testData",
        'testResults', jsonb_agg(jsonb_build_object(
        'id', step -> 'seqNumber',
        'name', step -> 'name',
        'output', step -> 'output' || COALESCE(step -> 'result' -> 'error_message', '""'),
        'status', step -> 'result' -> 'status'
        ))
        ) AS item
        FROM auto_case_audit, jsonb_array_elements(element -> 'steps') step
        WHERE "caseId" = #{id} AND "runId" = #{runId}
        GROUP BY "caseId", "runId", region, env, "issueKey", summary, "runStatus", element, "testData";
    </select>

    <select id="fetchValueFromAutoSystemVariables" parameterType="string" resultType="string">
        SELECT value
        FROM auto_system_variable
        WHERE config_key LIKE '%${key}%'
        LIMIT 1;
    </select>

    <select id="fetchSvcRegionsFromConfiguration" parameterType="map" resultType="map">
        SELECT "serviceName", regions
        FROM auto_api_configuration
        <if test="serviceNames != null and serviceNames.size() > 0">
            WHERE "serviceName" IN
            <foreach item="service" index="index" collection="serviceNames" open="(" separator="," close=")">
                #{service}
            </foreach>
        </if>
    </select>

    <select id="checkIgnoreAPIFromAutoEndpointAllIgnore" parameterType="map" resultType="boolean">
        SELECT COUNT(*)
        FROM auto_endpoint_all_ignore
        WHERE service_name = #{serviceName}
        AND path = #{path}
        AND method = #{method}
        AND reason != 'remove from dev';
    </select>

    <select id="selectIgnoreAPIMethodFromAutoEndpointAllIgnore" resultType="EndpointInfo">
        SELECT service_name AS serviceName, path, method
        FROM auto_endpoint_all_ignore
        WHERE path != '' AND method != '' AND reason != 'remove from dev';
    </select>

    <select id="checkExistFromAutoEndpointAllIgnore" parameterType="map" resultType="boolean">
        SELECT COUNT(*)
        FROM auto_endpoint_all_ignore
        WHERE service_name = #{serviceName}
        AND path = #{path}
        AND method = #{method}
        AND reason = #{reason};
    </select>

    <select id="selectIgnoreAPIFromAutoEndpointAllIgnore" resultType="EndpointInfo">
        SELECT service_name AS serviceName, path, method
        FROM auto_endpoint_all_ignore
        WHERE method = '' AND reason != 'remove from dev';
    </select>

    <select id="checkAPIFromAutoEndpointAll" parameterType="map" resultType="boolean">
        SELECT COUNT(*)
        FROM auto_endpoint_all
        WHERE service_name = #{serviceName}
        AND path = #{path}
        AND method = #{method};
    </select>

    <select id="selectFormerServiceNameFromAutoEndpointAllServiceMap" parameterType="string" resultType="string">
        SELECT former_service_name
        FROM auto_endpoint_all_service_map
        WHERE service_name = #{serviceName};
    </select>

    <select id="checkFormerServiceNameFromAutoEndpointAllServiceMap" parameterType="string" resultType="boolean">
        SELECT COUNT(*)
        FROM auto_endpoint_all_service_map
        WHERE service_name = #{serviceName};
    </select>

    <select id="selectServiceNameFromAutoEndpointAll" resultType="string">
        SELECT DISTINCT service_name
        FROM auto_endpoint_all;
    </select>

    <select id="selectServicesFromEhService" parameterType="boolean" resultType="string">
        SELECT "displayName"
        FROM eh_service
        WHERE ignore = #{ignore};
    </select>

    <select id="selectServicesFromAutoConfiguration" resultType="string">
        SELECT "serviceName"
        FROM auto_api_configuration
        WHERE "serviceName" != '' AND "fastProject" = 'EH.API';
    </select>

    <select id="selectComponentFromAutoConfiguration" parameterType="string" resultType="string">
        SELECT component
        FROM auto_api_configuration
        WHERE "serviceName" = #{serviceName};
    </select>

    <select id="selectDistinctFromAutoEndpoint" resultType="EndpointInfo">
        SELECT DISTINCT service_name AS serviceName, path, method
        FROM auto_endpoint
        WHERE service_name NOT IN ('elite', 'fund', 'useradmin', 'eh_trade_rate_schedule_svc');
    </select>

    <select id="selectEndpointInfoFromAutoEndpointAllByServiceName" parameterType="java.lang.String"
    resultType="EndpointInfo">
        SELECT service_name AS serviceName, path, method, is_coverage AS "isCoverage"
        FROM auto_endpoint_all
        WHERE service_name = #{serviceName};
    </select>

    <select id="selectEndpointInfoFromAutoEndpointAll" parameterType="java.util.List" resultType="EndpointInfo">
        SELECT service_name AS serviceName, path, method, active, inactive_reason AS inactiveReason
        FROM auto_endpoint_all
        <if test="serviceNames != null and serviceNames.size() > 0">
            WHERE service_name IN
            <foreach item="service" index="index" collection="serviceNames" open="(" separator="," close=")">
                #{service}
            </foreach>
        </if>
    </select>

    <select id="fetchEndpointCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM auto_case
        WHERE path = #{endpoint} AND method = #{method};
    </select>

    <select id="checkEndpointCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM auto_endpoint
        WHERE path = #{path} AND method = #{method} AND service_name = #{serviceName};
    </select>

    <select id="fetchAutoSysVariableValueByKeyName" parameterType="java.lang.String" resultType="java.lang.String">
        SELECT value
        FROM auto_system_variable
        WHERE config_key = #{key}
        LIMIT 1;
    </select>

    <select id="fetchRioMessageByTemplateName" parameterType="java.lang.String" resultType="AutoRioTemplate">
        SELECT name, "projectKey", component, feed, booking_system AS bookingSystem, region, baseline,
        ignore_tags AS ignoreTags
        FROM auto_rio_template
        WHERE name = #{name}
        LIMIT 1;
    </select>

    <select id="selectAllJiraAndDescription" resultType="JiraEntity">
        SELECT issue_key AS "issueKey", description AS summary
        FROM auto_case
        WHERE issue_key IS NOT NULL AND LENGTH(issue_key) > 0;
    </select>

    <select id="selectJiraAndDescriptionByIssueKey" parameterType="java.util.List" resultType="JiraEntity">
        SELECT issue_key AS "issueKey", description AS summary
        FROM auto_case
        <if test="issueKeys != null and issueKeys.size() > 0">
            WHERE issue_key IN
            <foreach item="issueKey" index="index" collection="issueKeys" open="(" separator="," close=")">
                #{issueKey}
            </foreach>
        </if>
    </select>

    <select id="selectStringListBySQL" parameterType="java.lang.String" resultType="java.lang.String">
        ${sql}
    </select>

    <select id="fetchAutoCaseAudit" parameterType="map" resultType="java.lang.String">
        SELECT jsonb_build_object(
        'runId', "runId",
        'suite', suite,
        'scenario', scenario,
        'region', region,
        'env', env,
        'issueKey', "issueKey",
        'summary', summary,
        'element', element,
        'runStatus', "runStatus",
        'script', script,
        'testData', "testData",
        'config', config,
        'runMode', "runMode",
        'caseId', "caseId",
        'label', label,
        'variables', variables
        )
        FROM auto_case_audit
        WHERE "runId" = #{runId} AND "caseId" = #{id}
        LIMIT 1;
    </select>

    <select id="fetchAutoCaseUIElementsByUIElement" parameterType="map" resultType="map">
        SELECT id, page, name, selector, frame, application
        FROM auto_case_ui_element
        WHERE page = #{page}
        AND name = #{name}
        AND selector = #{selector}
        AND frame = trim(#{frame})
        AND application = trim(#{application});
    </select>

    <select id="fetchAllAutoCaseUIElements" resultType="map">
        SELECT id, page, name, selector, frame, application
        FROM auto_case_ui_element;
    </select>

    <select id="fetchAllAutoCaseUI" resultType="map">
        WITH f AS (
            SELECT DISTINCT
            e.enable,
            e."isSanity",
            e.id,
            e.component,
            CAST(COALESCE(e."componentLike",'[]') AS varchar) AS "componentLikeStr",
            COALESCE(e."componentLike",'[]') AS "componentLike",
            e.scenario,
            CAST(COALESCE(e."profileSupport",'[]') AS varchar) AS "profileStr",
            COALESCE(e."profileSupport",'[]') AS profile,
            e.label,
            e."issueKey",
            e.summary,
            CAST(COALESCE(e.script,'[]') AS varchar) AS script,
            CAST(COALESCE(e."testData",'{}') AS varchar) AS "testData",
            CAST(COALESCE(e.variable,'{}') AS varchar) AS "caseVariables",
            COALESCE(a.namuat, 0.0) AS namuat,
            COALESCE(a.namdev, 0.0) AS namdev,
            COALESCE(a.namqa, 0.0) AS namqa,
            COALESCE(a.emeauat, 0.0) AS emeauat,
            COALESCE(a.emeadev, 0.0) AS emeadev,
            COALESCE(a.emeaqa, 0.0) AS emeaqa,
            COALESCE(a.apacuat, 0.0) AS apacuat,
            COALESCE(a.apacdev, 0.0) AS apacdev,
            COALESCE(a.apacqa, 0.0) AS apacqa,
            COALESCE(a.average, 0.0) AS average,
            e.application
            FROM auto_case_ui e
            LEFT JOIN auto_case_passrate a ON e.id = a."caseId"
        )
        SELECT
        f.id, f.enable, f."isSanity", f.component, f."issueKey", f.summary, f."testData",
        f.scenario, f.label, f."componentLikeStr", f."componentLike", f."profileStr", f.profile,
        f."caseVariables", f.script,
        f.namuat, f.namdev, f.namqa, f.emeauat, f.emeadev, f.emeaqa, f.apacuat, f.apacdev, f.apacqa,
        f.average, f.application
        FROM f;
    </select>

    <select id="fetchAutoCaseUIById" parameterType="java.lang.Integer" resultType="java.util.Map">
        WITH f AS (
            SELECT DISTINCT
            e.enable,
            e."isSanity",
            e.id,
            e.component,
            CAST(COALESCE(e."componentLike",'[]') AS varchar) AS "componentLikeStr",
            COALESCE(e."componentLike",'[]') AS "componentLike",
            e.scenario,
            CAST(COALESCE(e."profileSupport",'[]') AS varchar) AS "profileStr",
            COALESCE(e."profileSupport",'[]') AS profile,
            e.label,
            e."issueKey",
            e.summary,
            CAST(COALESCE(e.script,'[]') AS varchar) AS script,
            CAST(COALESCE(e."testData",'{}') AS varchar) AS "testData",
            CAST(COALESCE(e.variable,'{}') AS varchar) AS "caseVariables",
            COALESCE(a.namuat, 0.0) AS namuat,
            COALESCE(a.namdev, 0.0) AS namdev,
            COALESCE(a.namqa, 0.0) AS namqa,
            COALESCE(a.emeauat, 0.0) AS emeauat,
            COALESCE(a.emeadev, 0.0) AS emeadev,
            COALESCE(a.emeaqa, 0.0) AS emeaqa,
            COALESCE(a.apacuat, 0.0) AS apacuat,
            COALESCE(a.apacdev, 0.0) AS apacdev,
            COALESCE(a.apacqa, 0.0) AS apacqa,
            COALESCE(a.average, 0.0) AS average,
            e.application
            FROM
            auto_case_ui e
            LEFT JOIN auto_case_passrate a ON e.id = a."caseId"
        )
        <where>
            <if test="id != null and id != ''">
                AND e.id = #{id}
            </if>
        </where>
        SELECT
        f.id, f.enable, f."isSanity", f.component, f."issueKey", f.summary, f."testData",
        f.scenario, f.label, f."componentLikeStr", f."componentLike", f."profileStr", f.profile,
        f."caseVariables", f.script,
        f.namuat, f.namdev, f.namqa, f.emeauat, f.emeadev, f.emeaqa, f.apacuat, f.apacdev, f.apacqa,
        f.average, f.application
        FROM f;
    </select>

    <select id="fetchIdFromAutoCaseUIByComponentAndScenario" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT id
        FROM auto_case_ui
        WHERE component = #{component}
        AND scenario = #{scenario}
        AND summary = #{summary}
        AND "issueKey" = #{issueKey}
        AND label = #{label}
        LIMIT 1;
    </select>

    <select id="fetchAutoCaseUIBehaviorsBySearch" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT id, page, name, script, variable
        FROM auto_case_ui_behavior
        <where>
            <if test="globalSearch != null and globalSearch
            <if test="globalSearch != null and globalSearch != ''">
                AND (LOWER(page) LIKE '%${globalSearch}%' OR LOWER(name) LIKE '%${globalSearch}%' OR id::text =
                '${globalSearch}')
            </if>
            <if test="pageName != null and pageName != ''">
                AND LOWER(page) LIKE '%${pageName}%'
            </if>
            <if test="behaviorName != null and behaviorName != ''">
                AND LOWER(name) LIKE '%${behaviorName}%'
            </if>
            <if test="id != null and id != ''">
                AND id::text = #{id}
            </if>
        </where>
    </select>

    <select id="fetchAllAutoCaseUIBehaviors" resultType="java.util.Map">
        SELECT id, application, page, name, script, variable
        FROM auto_case_ui_behavior;
    </select>

    <select id="fetchAutoCaseUIBehaviorById" parameterType="java.lang.Integer" resultType="java.util.Map">
        SELECT id, application, page, name, script, variable
        FROM auto_case_ui_behavior
        WHERE id = #{id};
    </select>

    <select id="fetchIdFromAutoCaseUIPageByPageNameAndBehaviorName" parameterType="java.util.Map" resultType=
    "java.lang.Integer">
        SELECT id
        FROM auto_case_ui_behavior
        WHERE page = #{page} AND name = #{name}
        LIMIT 1;
    </select>

    <select id="fetchPageElementList" resultType="java.util.HashMap">
        SELECT page, json_agg(name)::text AS name
        FROM auto_case_ui_element
        GROUP BY page;
    </select>

    <select id="fetchPageBehaviorList" resultType="java.util.HashMap">
        SELECT page, json_agg(name)::text AS name
        FROM auto_case_ui_behavior
        GROUP BY page;
    </select>

    <select id="fetchAutoCaseBySearch" parameterType="java.util.Map" resultType="APIAutoCaseForUIResponse">
        WITH f AS (
            SELECT DISTINCT
            e.enable,
            e."isSanity",
            e.id,
            e.component,
            CAST(COALESCE(e."componentLike",'[]') AS varchar) AS "componentLikeStr",
            e.scenario,
            CAST(COALESCE(e.profile,'[]') AS varchar) AS "profileStr",
            e.label,
            e."issueKey",
            e.summary,
            e."isTemplate",
            COALESCE(e.endpoint,'') AS endpoint,
            COALESCE(e.method,'') AS method,
            COALESCE(e."endpointLike",'{}') AS "endpointLike",
            COALESCE(a.namuat, 0.0) AS namuat,
            COALESCE(a.namdev, 0.0) AS namdev,
            COALESCE(a.namqa, 0.0) AS namqa,
            COALESCE(a.emeauat, 0.0) AS emeauat,
            COALESCE(a.emeadev, 0.0) AS emeadev,
            COALESCE(a.emeaqa, 0.0) AS emeaqa,
            COALESCE(a.apacuat, 0.0) AS apacuat,
            COALESCE(a.apacdev, 0.0) AS apacdev,
            COALESCE(a.apacqa, 0.0) AS apacqa,
            COALESCE(a.average, 0.0) AS average
            FROM
            auto_case_scenario e
            LEFT JOIN auto_case_passrate a ON e.id = a."caseId"
            <where>
                <if test="search !=''" and search != null">
                    (CAST(e.id AS varchar) = #{search}
                    OR LOWER(e.summary) LIKE CONCAT('%', #{search}, '%')
                    OR LOWER(e.component) LIKE CONCAT('%', #{search}, '%')
                    OR LOWER(e."templateName") LIKE CONCAT('%', #{search}, '%')
                    OR LOWER(e."issueKey") LIKE CONCAT('%', #{search}, '%')
                    OR LOWER(e.scenario) LIKE CONCAT('%', #{search}, '%')
                    OR LOWER(e.label) LIKE CONCAT('%', #{search}, '%')
                    OR LOWER(CAST(e."componentLike" AS varchar)) LIKE CONCAT('%', #{search}, '%')
                    OR LOWER(CAST(e.profile AS varchar)) LIKE CONCAT('%', #{search}, '%')
                    OR LOWER(e.endpoint) LIKE CONCAT('%', #{search}, '%')
                    OR LOWER(e.method) LIKE CONCAT('%', #{search}, '%'))
                </if>
                <if test="id !=''" and id != null">
                    AND CAST(e.id AS varchar) = #{id}
                </if>
                <if test="summary !=''" and summary != null">
                    AND LOWER(e.summary) LIKE CONCAT('%', #{summary}, '%')
                </if>
                <if test="component !=''" and component != null">
                    AND LOWER(e.component) LIKE CONCAT('%', #{component}, '%')
                </if>
                <if test="issueKey !=''" and issueKey != null">
                    AND LOWER(e."issueKey") LIKE CONCAT('%', #{issueKey}, '%')
                </if>
                <if test="scenario !=''" and scenario != null">
                    AND LOWER(e.scenario) LIKE CONCAT('%', #{scenario}, '%')
                </if>
                <if test="label !=''" and label != null">
                    AND LOWER(e.label) LIKE CONCAT('%', #{label}, '%')
                </if>
                <if test="componentLike !=''" and componentLike != null">
                    AND LOWER(CAST(e."componentLike" AS varchar)) = CONCAT('%', #{componentLike}, '%')
                </if>
                <if test="profile !=''" and profile != null">
                    AND LOWER(CAST(e.profile AS varchar)) = CONCAT('%', #{profile}, '%')
                </if>
                <if test="endpoint !=''" and endpoint != null">
                    AND LOWER(e.endpoint) LIKE CONCAT('%', #{endpoint}, '%')
                </if>
                <if test="method !=''" and method != null">
                    AND LOWER(e.method) LIKE CONCAT('%', #{method}, '%')
                </if>
            </where>
        )
        SELECT
        f.id, f.enable, f."isSanity", f.component,
        f."issueKey", f.summary, f.scenario, f.label,
        f."componentLikeStr", f."profileStr", f."isTemplate",
        f.endpoint, f.method, f."endpointLike", f.namuat, f.namdev, f.namqa, f.emeauat,
        f.emeadev, f.emeaqa, f.apacuat, f.apacdev, f.apacqa, f.average
        FROM f;
    </select>

    <select id="fetchAutoCaseById" parameterType="java.lang.Integer" resultType="APIAutoCaseForUISingleIdResponse">
        WITH f AS (
            SELECT DISTINCT
            e.enable,
            e."isSanity",
            e.id,
            e.component,
            e."templateName" AS template,
            CAST(COALESCE(e."componentLike",'[]') AS varchar) AS "componentLikeStr",
            e.scenario,
            CAST(COALESCE(e.profile,'[]') AS varchar) AS "profileStr",
            e.label,
            e."issueKey",
            e.summary,
            CAST(COALESCE(e.script,'[]') AS varchar) AS script,
            CAST(COALESCE(e."testData",'{}') AS varchar) AS "testData",
            CASE WHEN e."isTemplate" IS TRUE THEN CAST(COALESCE(s.variables,'{}') AS varchar) ELSE '{}' END
            AS "templateVariables",
            CAST(COALESCE(e.variables,'{}') AS varchar) AS "caseVariables",
            e."isTemplate",
            COALESCE(e.endpoint,'') AS endpoint,
            COALESCE(e.method,'') AS method,
            COALESCE(e."endpointLike",'{}') AS "endpointLike",
            COALESCE(a.namuat, 0.0) AS namuat,
            COALESCE(a.namdev, 0.0) AS namdev,
            COALESCE(a.namqa, 0.0) AS namqa,
            COALESCE(a.emeauat, 0.0) AS emeauat,
            COALESCE(a.emeadev, 0.0) AS emeadev,
            COALESCE(a.emeaqa, 0.0) AS emeaqa,
            COALESCE(a.apacuat, 0.0) AS apacuat,
            COALESCE(a.apacdev, 0.0) AS apacdev,
            COALESCE(a.apacqa, 0.0) AS apacqa,
            COALESCE(a.average, 0.0) AS average
            FROM
            auto_case_scenario e
            LEFT JOIN auto_case_passrate a ON e.id = a."caseId"
            LEFT JOIN auto_case_template s ON s.component = e.component AND s."templateName" = e."templateName"
            <where>
                <if test="id != '' and id != null">
                    AND e.id = #{id}
                </if>
            </where>
        )
        SELECT
        f.id, f.enable, f."isSanity", f.component, f.template, f."issueKey", f.summary, f."testData",
        f.scenario, f.label, f."componentLikeStr", f."profileStr", f."isTemplate", f.endpoint, f.method, f."endpointLike",
        f."templateVariables", f."isTemplate", f.endpoint, f.method, f."endpointLike",
        f.namuat, f.namdev, f.namqa, f.emeauat, f.emeadev, f.emeaqa, f.apacuat, f.apacdev, f.apacqa, f.average
        FROM f;
    </select>

    <select id="fetchAllAutoCase" resultType="APIAutoCaseForUIResponse">
        WITH f AS (
            SELECT DISTINCT
            e.enable,
            e."isSanity",
            e.id,
            e.component,
            CAST(COALESCE(e."componentLike",'[]') AS varchar) AS "componentLikeStr",
            e.scenario,
            CAST(COALESCE(e.profile,'[]') AS varchar) AS "profileStr",
            e.label,
            e."issueKey",
            e.summary,
            e."isTemplate",
            COALESCE(e.endpoint,'') AS endpoint,
            COALESCE(e.method,'') AS method,
            COALESCE(e."endpointLike",'{}') AS "endpointLike",
            COALESCE(a.namuat, 0.0) AS namuat,
            COALESCE(a.namdev, 0.0) AS namdev,
            COALESCE(a.namqa, 0.0) AS namqa,
            COALESCE(a.emeauat, 0.0) AS emeauat,
            COALESCE(a.emeadev, 0.0) AS emeadev,
            COALESCE(a.emeaqa, 0.0) AS emeaqa,
            COALESCE(a.apacuat, 0.0) AS apacuat,
            COALESCE(a.apacdev, 0.0) AS apacdev,
            COALESCE(a.apacqa, 0.0) AS apacqa,
            COALESCE(a.average, 0.0) AS average
            FROM
            auto_case_scenario e
            LEFT JOIN auto_case_passrate a ON e.id = a."caseId"
        )
        SELECT
        f.id, f.enable, f."isSanity", f.component, f."issueKey", f.summary, f.scenario, f.label,
        f."componentLikeStr", f."profileStr", f."isTemplate", f.endpoint, f.method, f."endpointLike",
        f.namuat, f.namdev, f.namqa, f.emeauat, f.emeadev, f.emeaqa, f.apacuat, f.apacdev, f.apacqa, f.average
        FROM f;
    </select>
</mapper>